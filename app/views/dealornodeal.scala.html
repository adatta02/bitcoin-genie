@* dealornodeal Template File *@
@(game: AvailableKey, dealBoard: play.api.libs.json.JsValue)

@main("Play a game!", "deal-or-no-deal") {
           

<script type="text/template" id="boardTemplate">

<div id="boardTarget" class="container board-container">
    <div class="row">

        <div class="col-md-3 col-lg-2 sidebar-container">
        
          <div class="sidebar-profile">
            <div class="photo"><img src="@routes.Assets.at("images/profile.jpg")"></div>
            <div class="username">Ashish</div>
          </div>
          
          <div class="your-case">
            <div class="case-text">Your Case:</div>
            
            <div class="pick-one alert alert-white">Please pick one!</div>
            
            <% if( board.selectedBox !== null ){ %>
                <div class="case"><span><%= board.selectedBox + 1 %></span></div>
            <% } %>
            
          </div>
          
          <div class="recent-activity">
            <ul>
              <li>5,000 <span class="badge">#22</span> <span class="clearfix"></span></li>
              <li>15,000 <span class="badge">#2</span> <span class="clearfix"></span></li>   
              <li>1 <span class="badge">#7</span> <span class="clearfix"></span></li>
              <li>Offer: <span class="offer">45,000</span><span class="clearfix"></span></li>                          
            </ul>
          </div>
                  
        </div>

        <div class="col-md-9 col-lg-10">

            <div class="row header-container">
                <div class="col-md-9 col-lg-10">            
                  <div class="header"><img src="@routes.Assets.at("images/banner.png")"></div>            
                </div>
                <div class="col-md-3 col-lg-2">
                    <div class="btn-group game-buttons pull-right">
                        <a href="#" class="btn btn-transparent"><span class="glyphicon glyphicon-volume-off"></span></a>
                        <a href="#" class="btn btn-transparent"><span class="glyphicon glyphicon-question-sign"></span></a>              
                        <a href="#" class="btn btn-transparent"><span class="glyphicon glyphicon-off"></span></a>
                    </div>          
                </div>         
            </div>

            <div class="row inner-board-container">

              <div class="col-md-3 col-lg-2 remaining-amounts">
                  <ul>
                    <% for(var i = 0; i < Math.floor(board.amounts.length / 2); i ++){ %>
                        <li class="<%= board.amounts[i]["available"] ? "available" : "taken" %>"><span><%= board.amounts[i]["amount"] %></span></li>
                    <% } %>
                  </ul>
              </div>
              <div class="col-md-6 col-lg-8">
              
                <div class="case-container">
                
                    <% for(var i = 0; i < 4; i++ ){ %>
                        <ul class="board-row">
                            <% for(var j = rows[i][0]; j <= rows[i][rows[i].length-1]; j++){ %>
                                <li class="<%= window.getBoxAtPos(j-1).isPlayed ? "taken" : "" %>">
                                
                                    <a class="briefcase" data-provide="briefcase" href="#<%= (j-1) %>"
                                      <%= window.getBoxAtPos(j-1).isPlayed ? " data-isplayed=\"true\" " : "" %>>
                                        <div class="case">
                                            <span><%= j %></span>
                                        </div>
                                    </a>
                                    <div class="case-amount hidden"></div>
                                    
                                </li>
                            <% } %>
                        </ul>
                    <% } %>
                    
                </div>
                
                <div class="message-container">
                    <div class="alert message <%= status.length ? "" : "hidden" %>" data-provide="game-status">
                        <%= status %>
                    </div>
                </div>
                
                <div class="banker-container">
                    <ul class="offer-list">
                        <li class="offer-label">Your offer is: </li>
                        <li class="offer">51,000</li>
                    </ul>
                    
                    <ul class="list-inline">
                        <li><a href="#" class="btn btn-danger">Nope, no deal!</a></li>
                        <li><a href="#" class="btn btn-success">Ok, I'll take the deal!</a></li>
                    </ul>
                </div>
                
              </div>
              <div class="col-md-3 col-lg-2 remaining-amounts">
                  <ul>
                    <% for(var i = Math.floor(board.amounts.length / 2); i < board.amounts.length; i ++){ %>                
                        <li class="<%= board.amounts[i]["available"] ? "available" : "taken" %>"><span><%= board.amounts[i]["amount"] %></span></li>
                    <% } %>
                  </ul>
              </div>
             
            </div>
        </div>

    </div>
</div>

<div class="row margin-top">

<div class="col-md-2 amount-container">
    <div class="inner">
        <ul>
            <% for(var i = 0; i < Math.floor(board.amounts.length / 2); i ++){ %>
                <li class="<%= !board.amounts[i]["available"] ? "taken" : "" %>"><span><%= board.amounts[i]["amount"] %></span></li>
            <% } %>
        </ul>
    </div>

    <div class="your-case">
        <h3>Your Case</h3>
        <div class="case">
            <span><%= board.selectedBox ? board.selectedBox : "?" %></span> 
        </div>            
    </div>

</div>
<div class="col-md-8 game-container">

    <% for(var i = 0; i < 4; i++ ){ %>
        <ul class="board-row">
            <% for(var j = rows[i][0]; j <= rows[i][rows[i].length-1]; j++){ %>
                <li class="<%= window.getBoxAtPos(j-1).isPlayed ? "taken" : "" %>">
                    <a class="briefcase" data-provide="briefcase" href="#<%= (j-1) %>"
                      <%= window.getBoxAtPos(j-1).isPlayed ? " data-isplayed=\"true\" " : "" %>>
                        <%= j %>
                    </a>
                    <div class="case-amount hidden"></div>
                </li>
            <% } %>
        </ul>
    <% } %>

    <div class="row game-info-row">
        <div class="col-md-7">
            <div data-provide="game-status" 
                class="game-status alert alert-info <%= status.length ? "" : "hidden" %>">
                <%= status %>
            </div>    
        </div>
        <div class="col-md-5">
            <% if( board.lastAmount ){ %>
                <div class="last-amount">
                    Last Case: <%= board.lastAmount %>
                </div>
            <% } %>
        </div>
    </div>    

    <% if( board.yourBoxValue ){ %>
    <div class="row margin-top">
        <div class="col-md-8 col-md-offset-2">
            <div class="alert alert-success text-center">
                <h3>Your case contained: <%= board.yourBoxValue %></h3>
            </div>

            <div class="text-center send-btc-btn">
                <a href="#" data-provide="redeem-btc" class="btn btn-primary btn-lg">Redeem your BTC!</a>
            </div>
        </div>
    </div>
    <% } %>

</div>
<div class="col-md-2 amount-container">
    <div class="inner">
        <ul>
            <% for(var i = Math.floor(board.amounts.length / 2); i < board.amounts.length; i ++){ %>                
                <li class="<%= !board.amounts[i]["available"] ? "taken" : "" %>"><span><%= board.amounts[i]["amount"] %></span></li>
            <% } %>            
        </ul>
    </div>                        
</div>
</div>

</script>

<div class="modal fade" id="bankerModal">
  <div class="modal-dialog">
    <div class="modal-content">
      
      <div class="modal-header">        
        <h4 class="modal-title">An offer from the banker!</h4>
      </div>
      
      <div class="modal-body">
        <div data-provide="banker-info" class="alert alert-success text-center banker-info">
            The banker is contacting you with an offer. <br /> 
            His offer is based on the remaining cases and your performance so far. 
        </div>
        <div data-provide="banker-target"></div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Nope, No deal</button>
        <button type="button" class="btn btn-success" data-provide="take-deal">OK, I'll take the deal!</button>
      </div>
      
    </div>
  </div>
</div>

<div class="modal fade" id="switchBoxModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      
      <div class="modal-header">        
        <h4 class="modal-title">Trade Cases?</h4>
      </div>
      
      <div class="modal-body">
        <div data-provide="banker-info" class="alert alert-success text-center banker-info">
             <p>In the spirit of competition, the Banker will let you trade your case for the last case on the board.</p>
             <p><strong>Would you like to?</strong></p>
        </div>        
      </div>
      
      <div class="modal-footer">
        <a class="btn btn-danger" href="#nope" data-provide="trade-box">Nope, No trade</a>
        <a class="btn btn-success" href="#yes" data-provide="trade-box">Yes! Let's trade</a>
      </div>
      
    </div>
  </div>
</div>


<script type="text/template" id="bankerTemplate">
<div class="row">

  <div class="col-md-7">
    <div class="text-center banker-offer-container">
        <h3>Your offer is:</h3>
        <div class="banker-offer-amount"><%= board.currentOffer %></div>
    </div>
   </div>
  <div class="col-md-5">
    <h4>Previous Offers:</h4>
    <ul class="list-unstyled">
        <% _.each(board.pastOffers, function(val){ %>
            <li><%= val %></li>
        <% }); %>
    </ul>
  </div>
</div>
</script>

<script>

var board = @Html(dealBoard.toString);

function getBoxAtPos(position){
    return _.findWhere(board.boxes, {pos: position});
}

function fetchJson( payload, url ){

     if( !url ){
       url = "@routes.DealOrNoDeal.playDeal(game.publicKey)"
     }

    return $.ajax({url: url, type: "POST",
                  data: JSON.stringify(payload), 
                  contentType: "application/json; charset=utf-8",
                  dataType: "json",      
    });
}

function setGameStatus( status ){
    $("#boardTarget [data-provide='game-status']").html( status );
}

function renderBoard(status){
    var rows = [ _.range(1, 7), _.range(7, 14), _.range(14, 21), _.range(21, 27) ];
    var template = _.template( $("#boardTemplate").html() );
    
    $("body").html( template({board: board, rows: rows, status: status}) );
}

function showBankerOffer(){

    return false;
    
    var bankerTemplate = _.template( $("#bankerTemplate").html() );
    
    $("#bankerModal .modal-footer button").addClass("hidden");
    $("#bankerModal .banker-info").removeClass("hidden");    
    $("#bankerModal [data-provide='banker-target']").html("");
    
    $("#bankerModal").modal({keyboard: false});
    
    $("#bankerModal").on("shown.bs.modal", function(){    
        window.setTimeout(function(){
            $("#bankerModal .modal-footer button").removeClass("hidden");
            $("#bankerModal .banker-info").addClass("hidden");            
            $("#bankerModal [data-provide='banker-target']").html( bankerTemplate() );
        }, 3000);
    
        $("#bankerModal").off("shown.bs.modal");    
    });
    
}

function showSwitchModal(){
    $("#switchBoxModal").modal({keyboard: false});
}

function updateBoard(){

  if( board.selectedBox === null ){
    renderBoard("You need to pick 'your case' to start off!");
  }else{
    var status = (board.boxesToPick > 0) ? "Awesome. Just " + board.boxesToPick + " more to pick." : "";  
    renderBoard(status);
  }

  if( board.canSwitch ){
    showSwitchModal();
  }

  if( board.currentOffer ){
    showBankerOffer();            
  }
  
}

$(document).ready(function(){      
        
  updateBoard();
  
  $("#boardTarget").on("click", "[data-provide='redeem-btc']", function(){
  
    fetchJson({}, "@routes.DealOrNoDeal.getRedeemUrl(game.publicKey)").done(function(data){
        if( data.url.length == 0 ){
            alert("Sorry! You can't redeem anything right now.");
        }else{
            window.location = data.url;
        }
    });
  
    return false;
  });
  
  $("[data-provide='take-deal']").click(function(){
    
    fetchJson({}, "@routes.DealOrNoDeal.takeDeal(game.publicKey)").done(function(data){
        window.url = data.url;
    });
    
  });
  
  $("#boardTarget").on("click", "[data-provide='briefcase']", function(){
    
    if( $(this).data("isplayed") ){
        alert("Sorry! That case has already been played.");   
        return false;    
    }
        
    var pos = $(this).attr("href").replace("#", "");        
    
    if( board.selectedBox === null ){ 
        fetchJson( {action: "selectCase", pos: parseInt(pos)} ).success(function(data){
            board = data;
            updateBoard();            
        });                            
    }else{
        var fetchDf = fetchJson( {action: "openBox", pos: parseInt(pos)} ).done(function(data){ 
            board = data;
        });
        
        var li = $(this).parents("li:first");
        var offset = $(li).offset();
        var parentOffset = $(li).parents(".board-row:first").offset();
        var width = ($(".game-container").width() - 300) / 2;
        
        $('<div class="modal-backdrop fade in" />').appendTo( $("body") );    
        
        $(li).addClass("animated-amount");
        $(li).find("span").html("");
        
        console.log( offset.left );
        console.log( parentOffset.left ); 
        
        $(li).css({position: "absolute", left: offset.left - parentOffset.left, 
                   top: offset.top - parentOffset.top, "z-index": 1045});
        
        var animateDf = $.Deferred(); 
        
        $.when(fetchDf, animateDf).then(function(){
        
            $(li).find("span").html( board.lastAmount ).addClass("case-amount");
            
            window.setTimeout(function(){
                // $(".modal-backdrop").remove();
                // updateBoard();
            }, 3000);
                                
        });
        
        var top = ((parseInt(document.body.clientHeight) / 2) - (parseInt(228) / 2)) +'px';
        var left = ((parseInt(document.body.clientWidth) / 2) - (parseInt(256) / 2)) +'px';
        
        $(li).animate({top: top, left: left, "width": "256", "height": "228", left: width}, function(){animateDf.resolve();});
        
    }
    
    return false;
  });      
  
  $("#switchBoxModal").on("hide.bs.modal", function(){
    fetchJson({action: "declineSwitchBox"} ).success(function(data){
        board = data;
        updateBoard();        
    });  
  });
  
  $("#switchBoxModal").on("click", "[data-provide='trade-box']", function(){
    var action = $(this).attr("href").replace("#", "") == "yes" ? "switchBox" : "declineSwitchBox";
    
    fetchJson({action: action} ).success(function(data){
        $("#switchBoxModal").modal("hide");
        board = data;
        updateBoard();        
    });
                                        
    return false;
  });  

  
});
</script>

}